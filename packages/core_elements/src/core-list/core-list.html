<link rel=import href="../polymer/polymer.html"><link rel=import href="../core-selection/core-selection.html"><polymer-element name=core-list on-tap="{{tapHandler}}" tabindex=-1><template><core-selection id=selection multi="{{multi}}" on-core-select="{{selectedHandler}}"></core-selection><link rel=stylesheet href="core-list.css"><div id=viewport class=core-list-viewport><content></content></div></template><script>(function(){var a=navigator.userAgent.match(/iP(?:hone|ad;(?: U;)? CPU) OS (\d+)/);var b=a&&a[1]>=8;Polymer("core-list",{publish:{data:null,groups:null,scrollTarget:null,selectionEnabled:true,multi:false,selection:null,grid:false,width:null,height:200,runwayFactor:4},_scrollTop:0,observe:{"data grid width template scrollTarget":"initialize","multi selectionEnabled":"_resetSelection"},ready:function(){this._boundScrollHandler=this.scrollHandler.bind(this);this._boundPositionItems=this._positionItems.bind(this);this._oldMulti=this.multi;this._oldSelectionEnabled=this.selectionEnabled;this._virtualStart=0;this._virtualCount=0;this._physicalStart=0;this._physicalOffset=0;this._physicalSize=0;this._physicalSizes=[];this._physicalAverage=0;this._itemSizes=[];this._dividerSizes=[];this._repositionedItems=[];this._aboveSize=0;this._nestedGroups=false;this._groupStart=0;this._groupStartIndex=0;this._boundResizeHandler=this.updateSize.bind(this);window.addEventListener("resize",this._boundResizeHandler)},attached:function(){this.template=this.querySelector("template");if(!this.template.bindingDelegate){this.template.bindingDelegate=this.element.syntax}},detached:function(){this.removeEventListener(this._boundScrollHandler);this.removeEventListener(this._boundResizeHandler)},updateSize:function(){this._resetIndex(this._getFirstVisibleIndex());this.initializeData()},_resetSelection:function(){if(((this._oldMulti!=this.multi)&&!this.multi)||((this._oldSelectionEnabled!=this.selectionEnabled)&&!this.selectionEnabled)){this._clearSelection();this.refresh()}else{this.selection=this.$.selection.getSelection()}this._oldMulti=this.multi;this._oldSelectionEnabled=this.selectionEnabled},_adjustVirtualIndex:function(e,k){if(this._targetSize===0){return}var c=0;for(var d=0;d<e.length;d++){var n=e[d];var h=n.index;var l,m;if(k){l=this.data.indexOf(k);h+=this.virtualIndexForGroup(l)}if(h>=this._virtualStart){break}var j=Math.max(n.addedCount-n.removed.length,h-this._virtualStart);c+=j;this._physicalStart+=j;this._virtualStart+=j;if(this._grouped){if(k){m=n.index}else{var f=this.groupForVirtualIndex(n.index);l=f.group;m=f.groupIndex}if(l==this._groupStart&&m<this._groupStartIndex){this._groupStartIndex+=j}}}if(this._virtualStart<this._physicalCount){this._resetIndex(this._getFirstVisibleIndex())}else{c=Math.max((c/this._rowFactor)*this._physicalAverage,-this._physicalOffset);this._physicalOffset+=c;this._scrollTop=this.setScrollTop(this._scrollTop+c)}},_updateSelection:function(g){for(var e=0;e<g.length;e++){var f=g[e];for(var c=0;c<f.removed.length;c++){var h=f.removed[c];this.$.selection.setItemSelected(h,false)}}},groupsChanged:function(){if(!!this.groups!=this._grouped){this.initialize();this._resetIndex(this._getFirstVisibleIndex()||this._virtualStart)}},initialize:function(){if(!this.template){return}var d;if(arguments.length==1){d=arguments[0];if(!this._nestedGroups){this._adjustVirtualIndex(d)}this._updateSelection(d)}else{this._clearSelection()}var c=this.scrollTarget||this;if(this._target!==c){this.initializeScrollTarget(c)}this.initializeData(d,false)},initializeScrollTarget:function(c){if(this._target){this._target.removeEventListener("scroll",this._boundScrollHandler,false)}this._target=c;c.addEventListener("scroll",this._boundScrollHandler,false);if((c!=this)&&c.setScrollTop&&c.getScrollTop){this.setScrollTop=function(d){c.setScrollTop(d);return c.getScrollTop()};this.getScrollTop=c.getScrollTop.bind(c);this.syncScroller=c.sync?c.sync.bind(c):function(){};this.adjustPositionAllowed=false}else{this.setScrollTop=function(d){c.scrollTop=d;return c.scrollTop};this.getScrollTop=function(){return c.scrollTop};this.syncScroller=function(){};this.adjustPositionAllowed=true}if(b){c.style.webkitOverflowScrolling="touch";this.adjustPositionAllowed=false}this._target.style.willChange="transform";if(getComputedStyle(this._target).position=="static"){this._target.style.position="relative"}this.style.overflowY=(c==this)?"auto":null},updateGroupObservers:function(g){if(!this._nestedGroups){if(this._groupObservers&&this._groupObservers.length){g=[{index:0,addedCount:0,removed:this._groupObservers}]}else{g=null}}if(this._nestedGroups){g=g||[{index:0,addedCount:this.data.length,removed:[]}]}if(g){var k=this._groupObservers||[];for(var e=0;e<g.length;e++){var f=g[e],d;var c=[f.index,f.removed.length];if(f.removed.length){for(d=f.index;d<f.removed.length;d++){k[d].close()}}if(f.addedCount){for(d=f.index;d<f.addedCount;d++){var h=new ArrayObserver(this.data[d]);c.push(h);h.open(this.getGroupDataHandler(this.data[d]))}}k.splice.apply(k,c)}this._groupObservers=k}},getGroupDataHandler:function(c){return function(d){this.groupDataChanged(d,c)}.bind(this)},groupDataChanged:function(d,c){this._adjustVirtualIndex(d,c);this._updateSelection(d);this.initializeData(null,true)},initializeData:function(l,e){var j;if(this.grid){if(!this.width){throw"Grid requires the `width` property to be set"}this._rowFactor=Math.floor(this._target.offsetWidth/this.width)||1;this._rowMargin=(this._target.offsetWidth-(this._rowFactor*this.width))/2}else{this._rowFactor=1;this._rowMargin=0}if(!this.data||!this.data.length){this._virtualCount=0;this._grouped=false;this._nestedGroups=false}else{if(this.groups){this._grouped=true;this._nestedGroups=Array.isArray(this.data[0]);if(this._nestedGroups){if(this.groups.length!=this.data.length){throw"When using nested grouped data, data.length and groups.length must agree!"}this._virtualCount=0;for(j=0;j<this.groups.length;j++){this._virtualCount+=this.data[j]&&this.data[j].length}}else{this._virtualCount=this.data.length;var c=0;for(j=0;j<this.groups.length;j++){c+=this.groups[j].length}if(c!=this.data.length){throw"When using groups data, the sum of group[n].length's and data.length must agree!"}}var k=this.groupForVirtualIndex(this._virtualStart);this._groupStart=k.group;this._groupStartIndex=k.groupIndex}else{this._grouped=false;this._nestedGroups=false;this._virtualCount=this.data.length}}if(!e){this.updateGroupObservers(l)}var h=this._physicalCount||0;this._physicalCount=Math.min(Math.ceil(this._target.offsetHeight/(this._physicalAverage||this.height))*this.runwayFactor*this._rowFactor,this._virtualCount);this._physicalCount=Math.max(h,this._physicalCount);this._physicalData=this._physicalData||new Array(this._physicalCount);var f=false;while(h<this._physicalCount){var d=this.templateInstance?Object.create(this.templateInstance.model):{};this._physicalData[h++]=d;f=true}this.template.model=this._physicalData;this.template.setAttribute("repeat","");this._dir=0;if(!this._needItemInit){if(f){this._needItemInit=true;this.resetMetrics();this.onMutation(this,this.initializeItems)}else{this.refresh()}}},initializeItems:function(){var d=this._physicalItems&&this._physicalItems.length||0;this._physicalItems=this._physicalItems||[new Array(this._physicalCount)];this._physicalDividers=this._physicalDividers||new Array(this._physicalCount);for(var c=0,e=this.template.nextElementSibling;e&&c<this._physicalCount;e=e.nextElementSibling){if(e.getAttribute("divider")!=null){this._physicalDividers[c]=e}else{this._physicalItems[c++]=e}}this.refresh();this._needItemInit=false},_updateItemData:function(e,l,c,k,i){var m=this._physicalItems[l];var f=this._physicalData[l];var g=this.dataForIndex(c,k,i);var d;if(e||f.model!=g){f.model=g;f.index=c;f.physicalIndex=l;f.selected=this.selectionEnabled&&g?this._selectedData.get(g):null;if(this._grouped){var j=this.groups[k];f.groupModel=j&&(this._nestedGroups?j:j.data);f.groupIndex=k;f.groupItemIndex=i;m._isDivider=this.data.length&&(i===0);m._isRowStart=(i%this._rowFactor)===0}else{f.groupModel=null;f.groupIndex=null;f.groupItemIndex=null;m._isDivider=false;m._isRowStart=(c%this._rowFactor)===0}m.hidden=!g;var h=this._physicalDividers[l];if(h&&(h.hidden==m._isDivider)){h.hidden=!m._isDivider}d=!e}else{d=false}return d||e},scrollHandler:function(){if(b){if(!this._raf){this._raf=requestAnimationFrame(function(){this._raf=null;this.refresh()}.bind(this))}}else{this.refresh()}},resetMetrics:function(){this._physicalAverage=0;this._physicalAverageCount=0},updateMetrics:function(j){var c=0;var h=0;for(var e=0;e<this._physicalCount;e++){var g=this._physicalItems[e];if(!g.hidden){var d=this._itemSizes[e]=g.offsetHeight;if(g._isDivider){var f=this._physicalDividers[e];if(f){d+=(this._dividerSizes[e]=f.offsetHeight)}}this._physicalSizes[e]=d;if(g._isRowStart){c+=d;h++}}}this._physicalSize=c;this._viewportSize=this.$.viewport.offsetHeight;this._targetSize=this._target.offsetHeight;if(this._target!=this){el1=this.previousElementSibling;this._aboveSize=el1?el1.offsetTop+el1.offsetHeight:0}else{this._aboveSize=0}if(h){c=(this._physicalAverage*this._physicalAverageCount)+c;this._physicalAverageCount+=h;this._physicalAverage=Math.round(c/this._physicalAverageCount)}},getGroupLen:function(c){c=arguments.length?c:this._groupStart;if(this._nestedGroups){return this.data[c].length}else{return this.groups[c].length}},changeStartIndex:function(c){this._virtualStart+=c;if(this._grouped){while(c>0){var d=this.getGroupLen()-this._groupStartIndex-1;if(c>d){c-=(d+1);this._groupStart++;this._groupStartIndex=0}else{this._groupStartIndex+=c;c=0}}while(c<0){if(-c>this._groupStartIndex){c+=this._groupStartIndex;this._groupStart--;this._groupStartIndex=this.getGroupLen()}else{this._groupStartIndex+=c;c=this.getGroupLen()}}}if(this.grid){if(this._grouped){c=this._groupStartIndex%this._rowFactor}else{c=this._virtualStart%this._rowFactor}if(c){this.changeStartIndex(-c)}}},getRowCount:function(d){if(!this.grid){return d}else{if(!this._grouped){return d*this._rowFactor}else{if(d<0){if(this._groupStartIndex>0){return -Math.min(this._rowFactor,this._groupStartIndex)}else{var c=this.getGroupLen(this._groupStart-1);return -Math.min(this._rowFactor,c%this._rowFactor||this._rowFactor)}}else{return Math.min(this._rowFactor,this.getGroupLen()-this._groupStartIndex)}}}},_virtualToPhysical:function(c){var d=(c-this._physicalStart)%this._physicalCount;return d<0?this._physicalCount+d:d},groupForVirtualIndex:function(d){if(!this._grouped){return{}}else{var c;for(c=0;c<this.groups.length;c++){var e=this.getGroupLen(c);if(e>d){break}else{d-=e}}return{group:c,groupIndex:d}}},virtualIndexForGroup:function(d,c){c=c?Math.min(c,this.getGroupLen(d)):0;d--;while(d>=0){c+=this.getGroupLen(d--)}return c},dataForIndex:function(e,d,c){if(this.data){if(this._nestedGroups){if(e<this._virtualCount){return this.data[d][c]}}else{return this.data[e]}}},refresh:function(){var j,g;var k=this._scrollTop;this._scrollTop=this.getScrollTop();var f=this._scrollTop-k;this._dir=f<0?-1:f>0?1:0;if(Math.abs(f)>Math.max(this._physicalSize,this._targetSize)){g=Math.round((f/this._physicalAverage)*this._rowFactor);g=Math.max(g,-this._virtualStart);g=Math.min(g,this._virtualCount-this._virtualStart-1);this._physicalOffset+=Math.max(f,-this._physicalOffset);this.changeStartIndex(g)}else{var d=this._aboveSize+this._physicalOffset;var h=0.3*Math.max((this._physicalSize-this._targetSize,this._physicalSize));this._upperBound=d+h;this._lowerBound=d+this._physicalSize-this._targetSize-h;var c=this._dir>0?this._upperBound:this._lowerBound;if(((this._dir>0&&this._scrollTop>c)||(this._dir<0&&this._scrollTop<c))){var n=Math.abs(this._scrollTop-c);for(j=0;(j<this._physicalCount)&&(n>0)&&((this._dir<0&&this._virtualStart>0)||(this._dir>0&&this._virtualStart<this._virtualCount-this._physicalCount));j++){var l=this._virtualToPhysical(this._dir>0?this._virtualStart:this._virtualStart+this._physicalCount-1);var m=this._physicalSizes[l];n-=m;var e=this.getRowCount(this._dir);if(this._dir>0){this._physicalOffset+=m}this.changeStartIndex(e);if(this._dir<0){this._repositionedItems.push(this._virtualStart)}}}}if(this._updateItems(!f)){if(Observer.hasObjectObserve){this.async(this._boundPositionItems)}else{Platform.flush();Platform.endOfMicrotask(this._boundPositionItems)}}},_updateItems:function(h){var e,d,j;var f=false;var g=this._groupStart;var c=this._groupStartIndex;for(e=0;e<this._physicalCount;++e){d=this._virtualStart+e;j=this._virtualToPhysical(d);f=this._updateItemData(h,j,d,g,c)||f;c++;if(this.groups&&g<this.groups.length-1){if(c>=this.getGroupLen(g)){c=0;g++}}}return f},_positionItems:function(){var f,c,m,n;this.updateMetrics();if(this._dir<0){while(this._repositionedItems.length){c=this._repositionedItems.pop();m=this._virtualToPhysical(c);this._physicalOffset-=this._physicalSizes[m]}if(this._scrollTop+this._targetSize<this._viewportSize){this._updateScrollPosition(this._scrollTop)}}var e,d,l;var k=0;var j=this._rowMargin;var h=this._physicalOffset;var g=0;for(f=0;f<this._physicalCount;++f){c=this._virtualStart+f;m=this._virtualToPhysical(c);n=this._physicalItems[m];if(n._isDivider){if(k!==0){h+=g;k=0}e=this._physicalDividers[m];j=this._rowMargin;if(e&&(e._translateX!=j||e._translateY!=h)){e.style.opacity=1;if(this.grid){e.style.width=this.width*this._rowFactor+"px"}e.style.transform=e.style.webkitTransform="translate3d("+j+"px,"+h+"px,0)";e._translateX=j;e._translateY=h}h+=this._dividerSizes[m]}if(n._translateX!=j||n._translateY!=h){n.style.opacity=1;n.style.transform=n.style.webkitTransform="translate3d("+j+"px,"+h+"px,0)";n._translateX=j;n._translateY=h}g=this._itemSizes[m];if(this.grid){k++;if(k>=this._rowFactor){k=0;h+=g}j=this._rowMargin+k*this.width}else{h+=g}}if(this._scrollTop>=0){this._updateViewportHeight()}},_updateViewportHeight:function(){var c=Math.max(this._virtualCount-this._virtualStart-this._physicalCount,0);c=Math.ceil(c/this._rowFactor);var d=this._physicalOffset+this._physicalSize+c*this._physicalAverage;if(this._viewportSize!=d){this._viewportSize=d;this.$.viewport.style.height=this._viewportSize+"px";this.syncScroller()}},_updateScrollPosition:function(c){var d=this._virtualStart===0?this._physicalOffset:Math.min(c+this._physicalOffset,0);if(d){if(this.adjustPositionAllowed){this._scrollTop=this.setScrollTop(c-d)}this._physicalOffset-=d}},tapHandler:function(d){var f=d.target;var c=d.path;if(!this.selectionEnabled||(f===this)){return}requestAnimationFrame(function(){var i=window.ShadowDOMPolyfill?wrap(document.activeElement):this.shadowRoot.activeElement;if(i&&(i!=this)&&(i.parentElement!=this)&&(document.activeElement!=document.body)){return}if((c[0].localName=="input")||(c[0].localName=="button")||(c[0].localName=="select")){return}var e=f.templateInstance&&f.templateInstance.model;if(e){var h=this.dataForIndex(e.index,e.groupIndex,e.groupItemIndex);var g=this._physicalItems[e.physicalIndex];if(!this.multi&&h==this.selection){this.$.selection.select(null)}else{this.$.selection.select(h)}this.asyncFire("core-activate",{data:h,item:g})}}.bind(this))},selectedHandler:function(d,c){this.selection=this.$.selection.getSelection();var f=this.indexesForData(c.item);this._selectedData.set(c.item,c.isSelected);if(f.physical>=0&&f.virtual>=0){this.refresh()}},selectItem:function(c){if(!this.selectionEnabled){return}var d=this.data[c];if(d){this.$.selection.select(d)}},setItemSelected:function(d,c){var e=this.data[d];if(e){this.$.selection.setItemSelected(e,c)}},indexesForData:function(e){var f=-1;var c=0;if(this._nestedGroups){for(var d=0;d<this.groups.length;d++){f=this.data[d].indexOf(e);if(f<0){c+=this.data[d].length}else{f+=c;break}}}else{f=this.data.indexOf(e)}var g=this.virtualToPhysicalIndex(f);return{virtual:f,physical:g}},virtualToPhysicalIndex:function(d){for(var e=0,c=this._physicalData.length;e<c;e++){if(this._physicalData[e].index===d){return e}}return -1},clearSelection:function(){this._clearSelection();this.refresh()},_clearSelection:function(){this._selectedData=new WeakMap();this.$.selection.clear();this.selection=this.$.selection.getSelection()},_getFirstVisibleIndex:function(){for(var d=0;d<this._physicalCount;d++){var c=this._virtualStart+d;var f=this._virtualToPhysical(c);var e=this._physicalItems[f];if(e._translateY>=this._scrollTop){return c}}},_resetIndex:function(c){c=Math.min(c,this._virtualCount-1);c=Math.max(c,0);this.changeStartIndex(c-this._virtualStart);this._scrollTop=this.setScrollTop((c/this._rowFactor)*this._physicalAverage);this._physicalOffset=this._scrollTop;this._dir=0},scrollToItem:function(c){this.scrollToGroupItem(null,c)},scrollToGroup:function(c){this.scrollToGroupItem(c,0)},scrollToGroupItem:function(d,c){if(d!=null){c=this.virtualIndexForGroup(d,c)}this._resetIndex(c);this.refresh()}})})();</script></polymer-element>