<link rel=import href="../polymer/polymer.html"><link rel=import href="../core-selection/core-selection.html"><polymer-element name=core-selector attributes="selected multi valueattr selectedClass selectedProperty selectedAttribute selectedItem selectedModel selectedIndex notap excludedLocalNames target itemsSelector activateEvent"><template><core-selection id=selection multi="{{multi}}" on-core-select="{{selectionSelect}}"></core-selection><content id=items select="*"></content></template><script>Polymer("core-selector",{selected:null,multi:false,valueattr:"name",selectedClass:"core-selected",selectedProperty:"",selectedAttribute:"active",selectedItem:null,selectedModel:null,selectedIndex:-1,excludedLocalNames:"",target:null,itemsSelector:"",activateEvent:"tap",notap:false,defaultExcludedLocalNames:"template",observe:{"selected multi":"selectedChanged"},ready:function(){this.activateListener=this.activateHandler.bind(this);this.itemFilter=this.filterItem.bind(this);this.excludedLocalNamesChanged();this.observer=new MutationObserver(this.updateSelected.bind(this));if(!this.target){this.target=this}},get items(){if(!this.target){return[]}var a=this.target!==this?(this.itemsSelector?this.target.querySelectorAll(this.itemsSelector):this.target.children):this.$.items.getDistributedNodes();return Array.prototype.filter.call(a,this.itemFilter)},filterItem:function(a){return !this._excludedNames[a.localName]},excludedLocalNamesChanged:function(){this._excludedNames={};var a=this.defaultExcludedLocalNames;if(this.excludedLocalNames){a+=" "+this.excludedLocalNames}a.split(/\s+/g).forEach(function(b){this._excludedNames[b]=1},this)},targetChanged:function(a){if(a){this.removeListener(a);this.observer.disconnect();this.clearSelection()}if(this.target){this.addListener(this.target);this.observer.observe(this.target,{childList:true});this.updateSelected()}},addListener:function(a){Polymer.addEventListener(a,this.activateEvent,this.activateListener)},removeListener:function(a){Polymer.removeEventListener(a,this.activateEvent,this.activateListener)},get selection(){return this.$.selection.getSelection()},selectedChanged:function(){if(arguments.length===1){this.processSplices(arguments[0])}else{this.updateSelected()}},updateSelected:function(){this.validateSelected();if(this.multi){this.clearSelection(this.selected);this.selected&&this.selected.forEach(function(a){this.setValueSelected(a,true)},this)}else{this.valueToSelection(this.selected)}},validateSelected:function(){if(this.multi&&!Array.isArray(this.selected)&&this.selected!=null){this.selected=[this.selected]}else{if(!this.multi&&Array.isArray(this.selected)){var a=this.selected[0];this.clearSelection([a]);this.selected=a}}},processSplices:function(c){for(var b=0,d;d=c[b];b++){for(var a=0;a<d.removed.length;a++){this.setValueSelected(d.removed[a],false)}for(var a=0;a<d.addedCount;a++){this.setValueSelected(this.selected[d.index+a],true)}}},clearSelection:function(a){this.$.selection.selection.slice().forEach(function(c){var b=this.valueForNode(c)||this.items.indexOf(c);if(!a||a.indexOf(b)<0){this.$.selection.setItemSelected(c,false)}},this)},valueToSelection:function(b){var a=this.valueToItem(b);this.$.selection.select(a)},setValueSelected:function(c,a){var b=this.valueToItem(c);if(a^this.$.selection.isSelected(b)){this.$.selection.setItemSelected(b,a)}},updateSelectedItem:function(){this.selectedItem=this.selection},selectedItemChanged:function(){if(this.selectedItem){var a=this.selectedItem.templateInstance;this.selectedModel=a?a.model:undefined}else{this.selectedModel=null}this.selectedIndex=this.selectedItem?parseInt(this.valueToIndex(this.selected)):-1},valueToItem:function(a){return(a===null||a===undefined)?null:this.items[this.valueToIndex(a)]},valueToIndex:function(d){for(var b=0,a=this.items,e;(e=a[b]);b++){if(this.valueForNode(e)==d){return b}}return d},valueForNode:function(a){return a[this.valueattr]||a.getAttribute(this.valueattr)},selectionSelect:function(b,a){this.updateSelectedItem();if(a.item){this.applySelection(a.item,a.isSelected)}},applySelection:function(b,a){if(this.selectedClass){b.classList.toggle(this.selectedClass,a)}if(this.selectedProperty){b[this.selectedProperty]=a}if(this.selectedAttribute&&b.setAttribute){if(a){b.setAttribute(this.selectedAttribute,"")}else{b.removeAttribute(this.selectedAttribute)}}},activateHandler:function(d){if(!this.notap){var a=this.findDistributedTarget(d.target,this.items);if(a>=0){var c=this.items[a];var b=this.valueForNode(c)||a;if(this.multi){if(this.selected){this.addRemoveSelected(b)}else{this.selected=[b]}}else{this.selected=b}this.asyncFire("core-activate",{item:c})}}},addRemoveSelected:function(b){var a=this.selected.indexOf(b);if(a>=0){this.selected.splice(a,1)}else{this.selected.push(b)}},findDistributedTarget:function(c,a){while(c&&c!=this){var b=Array.prototype.indexOf.call(a,c);if(b>=0){return b}c=c.parentNode}},selectIndex:function(a){var b=this.items[a];if(b){this.selected=this.valueForNode(b)||a;return b}},selectPrevious:function(a){var b=a&&!this.selectedIndex?this.items.length-1:this.selectedIndex-1;return this.selectIndex(b)},selectNext:function(a){var b=a&&this.selectedIndex>=this.items.length-1?0:this.selectedIndex+1;return this.selectIndex(b)}});</script></polymer-element>