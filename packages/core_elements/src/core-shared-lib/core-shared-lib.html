<link rel=import href="../polymer/polymer.html"><polymer-element name=core-shared-lib attributes="url notifyEvent callbackName"><script>(function(){Polymer({notifyEvent:"core-shared-lib-load",ready:function(){if(!this.url&&this.defaultUrl){this.url=this.defaultUrl}},urlChanged:function(){b(this.url,this,this.callbackName)},provide:function(){this.async("notify")},notify:function(){this.fire(this.notifyEvent,arguments)}});var a={};function b(g,i,h){var f=c(g);var e=a[f];if(!e){e=a[f]=new d(f,g,h)}e.requestNotify(i)}function c(e){return e.replace(/[\:\/\%\?\&\.\=\-\,]/g,"_")+"_api"}var d=function(f,e,g){this.instances=[];this.callbackName=g;if(this.callbackName){window[this.callbackName]=this.success.bind(this)}else{if(e.indexOf(this.callbackMacro)>=0){this.callbackName=f+"_loaded";window[this.callbackName]=this.success.bind(this);e=e.replace(this.callbackMacro,this.callbackName)}else{throw"core-shared-api: a %%callback%% parameter is required in the API url"}}this.addScript(e)};d.prototype={callbackMacro:"%%callback%%",loaded:false,addScript:function(g){var e=document.createElement("script");e.src=g;e.onerror=this.error.bind(this);var f=document.querySelector("script");f.parentNode.insertBefore(e,f);this.script=e},removeScript:function(){if(this.script.parentNode){this.script.parentNode.removeChild(this.script)}this.script=null},error:function(){this.cleanup()},success:function(){this.loaded=true;this.cleanup();this.result=Array.prototype.slice.call(arguments);this.instances.forEach(this.provide,this);this.instances=null},cleanup:function(){delete window[this.callbackName]},provide:function(e){e.notify(e,this.result)},requestNotify:function(e){if(this.loaded){this.provide(e)}else{this.instances.push(e)}}}})();</script></polymer-element>