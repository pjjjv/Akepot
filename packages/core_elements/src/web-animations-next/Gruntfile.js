module.exports=function(e){function t(e,t,a){return m.uglify[t]={options:{sourceMap:!0,sourceMapName:t+".map",wrap:!1,compress:{global_defs:a,dead_code:!1},mangle:!1},nonull:!0,dest:t,src:e},"uglify:"+t}function a(a,n,r){var i=t([a],n,r),s=m.uglify[n];return s.options.sourceMapIn=a+".map",s.options.banner=e.file.read("templates/boilerplate"),s.options.wrap=!0,s.options.compress.dead_code=!0,s.options.mangle={eval:!0},i}function n(e){var t=c[e],a=[r("templates/web-animations.js",{target:e},e+".dev.js"),r("templates/web-animations.html",{src:t.src},e+".dev.html"),r("templates/runner.html",{target:e},"test/runner-"+e+".html")];return a}function r(e,t,a){var n={};return n[a]=[e],m.template[a]={options:{data:t},files:n},"template:"+a}function i(e,t){return m.wrap[t]={source:e,preamble:'(function() {\n  if (document.documentElement.animate) {\n    var player = document.documentElement.animate([], 0);\n    var load = true;\n    if (player) {\n      load = false;\n      "play|currentTime|pause|reverse|playbackRate|cancel|finish|startTime|playState".split("|").forEach(function(t) {\n        if (player[t] === undefined) {\n          load = true;\n        }\n      });\n    }\n    if (!load) { return; }  }\n',postamble:"})();"},"wrap:"+t}function s(e,t){return m.sourceMapConcat[t]={sources:e},"sourceMapConcat:"+t}function o(e){var r=c[e];return n(e).concat([t(r.scopeSrc.concat(r.sharedSrc).concat(r.minifillSrc),"inter-raw-"+e+".js",p),i("inter-raw-"+e+".js","inter-"+e+".js"),a("inter-"+e+".js",e+".min.js",p)])}function l(e){var r=c[e];return n(e).concat([t(r.scopeSrc.concat(r.sharedSrc),"inter-"+e+"-preamble.js",p),t(r.minifillSrc,"inter-component-"+e+"minifill.js",p),i("inter-component-"+e+"minifill.js","inter-guarded-"+e+"-minifill.js"),t(r.maxifillSrc,"inter-component-"+e+".js",p),s(["inter-"+e+"-preamble.js","inter-guarded-"+e+"-minifill.js","inter-component-"+e+".js"],"inter-"+e+".js"),a("inter-"+e+".js",e+".min.js",p)])}e.loadNpmTasks("grunt-contrib-uglify"),e.loadNpmTasks("grunt-gjslint"),e.loadNpmTasks("grunt-checkrepo"),e.loadNpmTasks("grunt-karma"),e.loadNpmTasks("grunt-saucelabs"),e.loadNpmTasks("grunt-git-status"),e.loadNpmTasks("grunt-template");var c=require("./target-config.js"),u=require("source-map"),m={uglify:{},template:{},wrap:{},sourceMapConcat:{}},p={WEB_ANIMATIONS_TESTING:!1};e.registerTask("web-animations",o("web-animations")),e.registerTask("web-animations-next",l("web-animations-next")),e.registerTask("web-animations-next-lite",l("web-animations-next-lite"));var g={"web-animations":{},"web-animations-next":{}};e.initConfig({uglify:m.uglify,template:m.template,wrap:m.wrap,sourceMapConcat:m.sourceMapConcat,checkrepo:{all:{clean:!0}},"git-status":{all:{}},gjslint:{options:{flags:["--nojsdoc","--strict","--disable 7,121,110"],reporter:{name:"console"}},all:{src:["src/*.js","test/*.js","test/js/*.js"]}},test:g,sauce:g}),e.task.registerMultiTask("test","Run <target> tests under Karma",function(){var e=this.async(),t=require("karma/lib/config").parseConfig(require("path").resolve("test/karma-config.js"),{}),a=c[this.target];t.files=["test/runner.js"].concat(a.src,a.test);var n=require("karma").server;n.start(t,function(t){e(0===t)})}),e.task.registerMultiTask("sauce","Run <target> tests under Karma on Saucelabs",function(){var e=this.async(),t=require("karma/lib/config").parseConfig(require("path").resolve("test/karma-config-ci.js"),{}),a=c[this.target];t.files=["test/runner.js"].concat(a.src,a.test),t.sauceLabs.testName="web-animation-next "+this.target+" Unit tests";var n=require("karma").server;n.start(t,function(t){e(0===t)})}),e.task.registerMultiTask("sourceMapConcat","concat source files and produce combined source map",function(){for(var t=this.data.sources.map(e.file.read),a=this.data.sources.map(function(t){return e.file.read(t+".map")}),n="",r=new u.SourceMapGenerator({file:this.target}),i=0,s=0;s<t.length;s++){n+=t[s],new u.SourceMapConsumer(a[s]).eachMapping(function(e){r.addMapping({generated:{line:e.generatedLine+i,column:e.generatedColumn},original:{line:e.originalLine,column:e.originalColumn},source:e.source,name:e.name})});var o=t[s].split("\n");i+=o.length,"\n"!==t[s][t[s].length-1]&&(n+="\n")}e.file.write(this.target,n),e.file.write(this.target+".map",r.toString())}),e.task.registerMultiTask("wrap","Wrap <target> source file and update source map",function(){for(var t=e.file.read(this.data.source),a=e.file.read(this.data.source+".map"),n=t.split("\n"),r=0;n[r].length<2||"//"==n[r].substring(0,2);)r++;var i=this.data.postamble;if("//# sourceMappingURL="==n[n.length-1].substring(0,21)&&(i+="\n//# sourceMappingURL="+this.target+".map"),r>0)var s=n.slice(0,r).join("\n")+"\n";else var s="";var o=n.slice(r,n.length-1).join("\n");e.file.write(this.target,s+this.data.preamble+o+i);var l=this.data.preamble.split("\n"),c=l.length;if("\n"==this.data.preamble[this.data.preamble.length-1])var m=0;else{var m=l[c-1].length;c-=1}var p=new u.SourceMapConsumer(a),g=new u.SourceMapGenerator({file:this.target});p.eachMapping(function(e){e.generatedLine==r+1&&(e.generatedColumn+=m),e.generatedLine+=c,g.addMapping({generated:{line:e.generatedLine,column:e.generatedColumn},original:{line:e.originalLine,column:e.originalColumn},source:e.source,name:e.name})}),e.file.write(this.target+".map",g.toString())}),e.task.registerTask("clean","Remove files generated by grunt",function(){e.file.expand("web-animations*").concat(e.file.expand("test/runner-*.html")).concat(e.file.expand("inter-*")).forEach(function(t){e.file.delete(t),e.log.writeln("File "+t+" removed")})}),e.task.registerTask("default",["web-animations","web-animations-next","web-animations-next-lite","gjslint"])};